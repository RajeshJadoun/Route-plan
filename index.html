<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Field Force Management System</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary: #5E3FBE;
      --primary-dark: #4A2F9E;
      --primary-light: #7C5CE5;
      --secondary: #00BFA5;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --dark: #1F2937;
      --gray: #6B7280;
      --light-gray: #F3F4F6;
      --white: #FFFFFF;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      --gradient-soft: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark);
      position: relative;
      overflow-x: hidden;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    .app-container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header Section */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 56px;
      height: 56px;
      background: var(--gradient);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      box-shadow: var(--shadow-lg);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-subtitle {
      font-size: 14px;
      color: var(--gray);
      margin-top: 4px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .pulse {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    /* User Card */
    .user-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    .user-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: var(--gradient);
      opacity: 0.05;
      border-radius: 50%;
      transform: translate(50%, -50%);
    }

    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .user-details {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-avatar {
      width: 56px;
      height: 56px;
      background: var(--gradient);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      font-weight: 600;
      box-shadow: var(--shadow);
    }

    .user-text h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 4px;
    }

    .user-text p {
      font-size: 14px;
      color: var(--gray);
    }

    .reset-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    .reset-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    /* Route Plan Section */
    .route-section {
      background: white;
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
    }

    .route-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .route-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: var(--shadow);
    }

    .route-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .route-display {
      background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid #E5E7EB;
      min-height: 60px;
      display: flex;
      align-items: center;
    }

    .route-display p {
      color: var(--dark);
      font-size: 14px;
      line-height: 1.6;
    }

    .route-input-group {
      display: flex;
      gap: 12px;
    }

    .route-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .route-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(94, 63, 190, 0.1);
    }

    .btn-apply {
      padding: 12px 24px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    .btn-apply:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    /* Action Cards */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .action-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      transition: all 0.3s ease;
    }

    .action-card.checkin::before {
      background: linear-gradient(90deg, #10B981 0%, #059669 100%);
    }

    .action-card.checkout::before {
      background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
    }

    .action-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .action-card-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }

    .action-card.checkin .action-card-icon {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .action-card.checkout .action-card-icon {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    }

    .action-card h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .action-card p {
      font-size: 14px;
      color: var(--gray);
      line-height: 1.5;
    }

    /* Form Sections */
    .form-section {
      background: white;
      border-radius: 20px;
      padding: 28px;
      box-shadow: var(--shadow-xl);
      margin-bottom: 24px;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .form-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #F3F4F6;
    }

    .form-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: var(--shadow);
    }

    .form-icon.checkin {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
    }

    .form-icon.checkout {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
    }

    .form-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(94, 63, 190, 0.1);
    }

    /* Transport Options */
    .transport-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .transport-option {
      padding: 16px;
      border: 2px solid #E5E7EB;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
      text-align: center;
    }

    .transport-option:hover {
      border-color: var(--primary-light);
      background: rgba(94, 63, 190, 0.05);
    }

    .transport-option.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(94, 63, 190, 0.1) 0%, rgba(124, 92, 229, 0.1) 100%);
      box-shadow: var(--shadow);
    }

    .transport-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .transport-name {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 4px;
    }

    .transport-desc {
      font-size: 12px;
      color: var(--gray);
    }

    /* Photo Capture */
    .photo-section {
      background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
      border-radius: 16px;
      padding: 20px;
      margin-top: 12px;
      border: 2px dashed #E5E7EB;
      text-align: center;
    }

    .btn-capture {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: white;
      border: 2px solid var(--primary);
      color: var(--primary);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }

    .btn-capture:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .photo-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
      margin-top: 16px;
      box-shadow: var(--shadow-lg);
      object-fit: cover;
    }

    /* Expense Inputs */
    .expense-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .expense-input {
      position: relative;
    }

    .expense-input input {
      width: 100%;
      padding: 12px 12px 12px 32px;
      border: 2px solid #E5E7EB;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .expense-input input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(94, 63, 190, 0.1);
    }

    .expense-input::before {
      content: '₹';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-weight: 600;
    }

    /* Submit Button */
    .btn-submit {
      width: 100%;
      padding: 14px 24px;
      background: var(--gradient);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-lg);
      margin-top: 24px;
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Alerts */
    .alert {
      padding: 16px 20px;
      border-radius: 12px;
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.4s ease-out;
      box-shadow: var(--shadow);
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .alert.success {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
    }

    .alert.error {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      color: white;
    }

    .alert-icon {
      font-size: 20px;
    }

    /* Footer */
    .footer {
      text-align: center;
      color: white;
      padding: 24px;
      font-size: 14px;
      opacity: 0.9;
    }

    .hidden {
      display: none !important;
    }

    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .app-container {
        padding: 12px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .action-grid {
        grid-template-columns: 1fr;
      }

      .transport-grid {
        grid-template-columns: 1fr;
      }

      .expense-grid {
        grid-template-columns: 1fr 1fr;
      }

      .route-input-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">📍</div>
          <div>
            <h1>Field Force Management</h1>
            <div class="header-subtitle">Marketing Team Operations Portal</div>
          </div>
        </div>
        <div class="status-badge">
          <span class="pulse"></span>
          System Online
        </div>
      </div>
    </div>

    <!-- User Card -->
    <div class="user-card">
      <div class="user-info">
        <div class="user-details">
          <div class="user-avatar" id="userAvatar">FA</div>
          <div class="user-text">
            <h2 id="userName">Field Agent</h2>
            <p id="userEmail">local@local</p>
          </div>
        </div>
        <button class="reset-btn" onclick="resetApp()">
          🔄 Reset System
        </button>
      </div>
    </div>

    <!-- Route Plan Section -->
    <div class="route-section">
      <div class="route-header">
        <div class="route-icon">📋</div>
        <div class="route-title">Today's Route Plan</div>
      </div>
      <div class="route-display">
        <p id="routePlanText">No route plan configured. Please set your daily route below.</p>
      </div>
      <div class="route-input-group">
        <input type="text" class="route-input" id="globalRoutePlan" placeholder="Enter your route plan for today...">
        <button class="btn-apply" onclick="applyRoutePlan()">Apply Plan</button>
      </div>
    </div>

    <!-- Action Cards -->
    <div class="action-grid">
      <div class="action-card checkin" onclick="startCheckin()">
        <div class="action-card-icon">✅</div>
        <h3>Check-In</h3>
        <p>Start your field visit by recording meter reading and route details</p>
      </div>
      <div class="action-card checkout" onclick="startCheckout()">
        <div class="action-card-icon">📤</div>
        <h3>Check-Out</h3>
        <p>Complete your visit with expenses and final meter reading</p>
      </div>
    </div>

    <!-- Check-in Form -->
    <div id="checkinForm" class="form-section hidden">
      <div class="form-header">
        <div class="form-icon checkin">✅</div>
        <div class="form-title">Check-In Process</div>
      </div>
      
      <div class="form-group">
        <label for="customRoutePlan">Custom Route Plan (Optional)</label>
        <textarea class="form-input" id="customRoutePlan" rows="3" placeholder="Override default route plan if needed..."></textarea>
      </div>

      <div class="form-group">
        <label>Vehicle Meter Reading</label>
        <div class="photo-section">
          <button class="btn-capture" onclick="capturePhoto('meterIn')" id="meterInBtn">
            📷 Capture Meter Photo
          </button>
          <img id="meterInPreview" class="photo-preview hidden" alt="Meter reading">
        </div>
      </div>

      <button class="btn-submit" onclick="submitCheckin()" id="checkinSubmitBtn">
        Complete Check-In
      </button>
    </div>

    <!-- Check-out Form -->
    <div id="checkoutForm" class="form-section hidden">
      <div class="form-header">
        <div class="form-icon checkout">📤</div>
        <div class="form-title">Check-Out Process</div>
      </div>

      <div class="form-group">
        <label>Transportation Method</label>
        <div class="transport-grid">
          <div class="transport-option" onclick="selectTransport('local')" id="localTransport">
            <div class="transport-icon">🚗</div>
            <div class="transport-name">Company Vehicle</div>
            <div class="transport-desc">Meter reading required</div>
          </div>
          <div class="transport-option" onclick="selectTransport('public')" id="publicTransport">
            <div class="transport-icon">🚌</div>
            <div class="transport-name">Public Transport</div>
            <div class="transport-desc">Ticket photo required</div>
          </div>
        </div>
      </div>

      <div id="localVehicleSection" class="form-group hidden">
        <label>Final Meter Reading</label>
        <div class="photo-section">
          <button class="btn-capture" onclick="capturePhoto('meterOut')" id="meterOutBtn">
            📷 Capture Final Meter
          </button>
          <img id="meterOutPreview" class="photo-preview hidden" alt="Final meter">
        </div>
      </div>

      <div id="publicTransportSection" class="form-group hidden">
        <label>Travel Ticket</label>
        <div class="photo-section">
          <button class="btn-capture" onclick="capturePhoto('ticket')" id="ticketBtn">
            🎫 Capture Ticket
          </button>
          <img id="ticketPreview" class="photo-preview hidden" alt="Travel ticket">
        </div>
      </div>

      <div class="form-group">
        <label>Expense Details</label>
        <div class="expense-grid">
          <div class="expense-input">
            <input type="number" id="travelExpense" placeholder="Travel" min="0" step="0.01">
          </div>
          <div class="expense-input">
            <input type="number" id="foodExpense" placeholder="Food" min="0" step="0.01">
          </div>
          <div class="expense-input">
            <input type="number" id="otherExpense" placeholder="Other" min="0" step="0.01">
          </div>
        </div>
      </div>

      <button class="btn-submit" onclick="submitCheckout()" id="checkoutSubmitBtn">
        Complete Check-Out
      </button>
    </div>

    <div id="alertContainer"></div>
  </div>

  <div class="footer">
    <div>🔒 Enterprise Field Force Management System</div>
    <div style="margin-top: 8px; opacity: 0.8;">Powered by Advanced Analytics & Real-time Sync</div>
  </div>

  <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

  <script>
    // Configuration - UPDATE THIS WITH YOUR GOOGLE APPS SCRIPT URL
    const SCRIPT_URL = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE";

    // Application State Management
    let appState = {
      user: {
        email: 'local@local',
        displayName: 'Field Agent',
        routePlan: ''
      },
      capturedPhotos: {},
      currentPhotoType: null,
      transportMethod: null,
      sessionData: [],
      offlineQueue: []
    };

    // Initialize Application
    function initializeApp() {
      loadUserRoute();
      updateUserDisplay();
      syncOfflineData();
      getCurrentLocation();
    }

    // Load saved route plan
    function loadUserRoute() {
      const savedRoute = getFromStorage('userRoutePlan');
      if (savedRoute) {
        appState.user.routePlan = savedRoute;
        document.getElementById('routePlanText').textContent = savedRoute;
        document.getElementById('globalRoutePlan').value = savedRoute;
      }
    }

    // Update user display
    function updateUserDisplay() {
      const { displayName, email } = appState.user;
      document.getElementById('userName').textContent = displayName;
      document.getElementById('userEmail').textContent = email;
      document.getElementById('userAvatar').textContent = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
    }

    // Apply route plan
    function applyRoutePlan() {
      const routeInput = document.getElementById('globalRoutePlan');
      const routePlan = routeInput.value.trim();
      
      if (!routePlan) {
        showAlert('Please enter a route plan', 'error');
        return;
      }

      appState.user.routePlan = routePlan;
      document.getElementById('routePlanText').textContent = routePlan;
      saveToStorage('userRoutePlan', routePlan);
      
      // Save to backend
      saveRouteToBackend(routePlan);
      
      showAlert('Route plan updated successfully!', 'success');
    }

    // Save route to backend
    async function saveRouteToBackend(routePlan) {
      try {
        const data = {
          action: 'saveRoute',
          userEmail: appState.user.email,
          routePlan: routePlan
        };
        
        await sendToBackend(data);
      } catch (error) {
        console.error('Failed to save route to backend:', error);
        // Still works offline
      }
    }

    // Start check-in process
    function startCheckin() {
      hideAllForms();
      document.getElementById('checkinForm').classList.remove('hidden');
      
      // Pre-fill custom route with current route
      const customRoute = document.getElementById('customRoutePlan');
      if (appState.user.routePlan) {
        customRoute.placeholder = `Current: ${appState.user.routePlan}`;
      }
    }

    // Start check-out process
    function startCheckout() {
      hideAllForms();
      document.getElementById('checkoutForm').classList.remove('hidden');
      
      // Reset transport selection
      appState.transportMethod = null;
      document.querySelectorAll('.transport-option').forEach(option => {
        option.classList.remove('active');
      });
      document.getElementById('localVehicleSection').classList.add('hidden');
      document.getElementById('publicTransportSection').classList.add('hidden');
    }

    // Hide all forms
    function hideAllForms() {
      document.getElementById('checkinForm').classList.add('hidden');
      document.getElementById('checkoutForm').classList.add('hidden');
    }

    // Select transport method
    function selectTransport(method) {
      appState.transportMethod = method;
      
      // Update UI
      document.querySelectorAll('.transport-option').forEach(option => {
        option.classList.remove('active');
      });
      document.getElementById(method + 'Transport').classList.add('active');
      
      // Show/hide relevant sections
      if (method === 'local') {
        document.getElementById('localVehicleSection').classList.remove('hidden');
        document.getElementById('publicTransportSection').classList.add('hidden');
      } else {
        document.getElementById('localVehicleSection').classList.add('hidden');
        document.getElementById('publicTransportSection').classList.remove('hidden');
      }
    }

    // Capture photo
    function capturePhoto(type) {
      appState.currentPhotoType = type;
      const input = document.getElementById('cameraInput');
      input.click();
    }

    // Handle photo capture
    document.getElementById('cameraInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const base64Data = event.target.result;
        const photoType = appState.currentPhotoType;
        
        // Store photo
        appState.capturedPhotos[photoType] = base64Data;
        
        // Show preview
        const preview = document.getElementById(photoType + 'Preview');
        if (preview) {
          preview.src = base64Data;
          preview.classList.remove('hidden');
        }
        
        // Update button text
        const button = document.getElementById(photoType + 'Btn');
        if (button) {
          button.innerHTML = '✅ Photo Captured';
          button.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
          button.style.color = 'white';
        }
      };
      reader.readAsDataURL(file);
    });

    // Submit check-in
    async function submitCheckin() {
      const submitBtn = document.getElementById('checkinSubmitBtn');
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> Processing...';
        
        const customRoute = document.getElementById('customRoutePlan').value.trim();
        const location = await getCurrentLocation();
        
        const checkinData = {
          action: 'checkin',
          userEmail: appState.user.email,
          routePlan: appState.user.routePlan,
          customRoutePlan: customRoute,
          meterPhoto: appState.capturedPhotos.meterIn,
          location: location,
          timestamp: new Date().toISOString()
        };
        
        // Try to send to backend
        try {
          await sendToBackend(checkinData);
          showAlert('Check-in completed successfully!', 'success');
        } catch (error) {
          // Save for offline sync
          addToOfflineQueue(checkinData);
          showAlert('Check-in saved offline. Will sync when connection is restored.', 'success');
        }
        
        // Reset form
        resetCheckinForm();
        hideAllForms();
        
      } catch (error) {
        console.error('Check-in error:', error);
        showAlert('Check-in failed. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Submit check-out
    async function submitCheckout() {
      const submitBtn = document.getElementById('checkoutSubmitBtn');
      const originalText = submitBtn.textContent;
      
      try {
        // Validate transport selection
        if (!appState.transportMethod) {
          showAlert('Please select a transportation method', 'error');
          return;
        }
        
        // Validate required photo
        if (appState.transportMethod === 'local' && !appState.capturedPhotos.meterOut) {
          showAlert('Please capture the final meter reading', 'error');
          return;
        }
        
        if (appState.transportMethod === 'public' && !appState.capturedPhotos.ticket) {
          showAlert('Please capture the travel ticket', 'error');
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading"></span> Processing...';
        
        const location = await getCurrentLocation();
        const expenses = {
          travel: parseFloat(document.getElementById('travelExpense').value) || 0,
          food: parseFloat(document.getElementById('foodExpense').value) || 0,
          other: parseFloat(document.getElementById('otherExpense').value) || 0
        };
        
        const checkoutData = {
          action: 'checkout',
          userEmail: appState.user.email,
          transportMethod: appState.transportMethod,
          meterPhoto: appState.capturedPhotos.meterOut,
          ticketPhoto: appState.capturedPhotos.ticket,
          expenses: expenses,
          location: location,
          timestamp: new Date().toISOString()
        };
        
        // Try to send to backend
        try {
          await sendToBackend(checkoutData);
          showAlert(`Check-out completed! Total expenses: ₹${expenses.travel + expenses.food + expenses.other}`, 'success');
        } catch (error) {
          // Save for offline sync
          addToOfflineQueue(checkoutData);
          showAlert('Check-out saved offline. Will sync when connection is restored.', 'success');
        }
        
        // Reset form
        resetCheckoutForm();
        hideAllForms();
        
      } catch (error) {
        console.error('Check-out error:', error);
        showAlert('Check-out failed. Please try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    // Reset check-in form
    function resetCheckinForm() {
      document.getElementById('customRoutePlan').value = '';
      delete appState.capturedPhotos.meterIn;
      
      const preview = document.getElementById('meterInPreview');
      const button = document.getElementById('meterInBtn');
      
      if (preview) {
        preview.classList.add('hidden');
        preview.src = '';
      }
      
      if (button) {
        button.innerHTML = '📷 Capture Meter Photo';
        button.style.background = 'white';
        button.style.color = 'var(--primary)';
      }
    }

    // Reset check-out form
    function resetCheckoutForm() {
      // Reset transport selection
      appState.transportMethod = null;
      document.querySelectorAll('.transport-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // Reset photos
      delete appState.capturedPhotos.meterOut;
      delete appState.capturedPhotos.ticket;
      
      // Reset previews and buttons
      ['meterOut', 'ticket'].forEach(type => {
        const preview = document.getElementById(type + 'Preview');
        const button = document.getElementById(type + 'Btn');
        
        if (preview) {
          preview.classList.add('hidden');
          preview.src = '';
        }
        
        if (button) {
          const icon = type === 'ticket' ? '🎫' : '📷';
          const text = type === 'ticket' ? 'Capture Ticket' : 'Capture Final Meter';
          button.innerHTML = `${icon} ${text}`;
          button.style.background = 'white';
          button.style.color = 'var(--primary)';
        }
      });
      
      // Reset expenses
      document.getElementById('travelExpense').value = '';
      document.getElementById('foodExpense').value = '';
      document.getElementById('otherExpense').value = '';
      
      // Hide sections
      document.getElementById('localVehicleSection').classList.add('hidden');
      document.getElementById('publicTransportSection').classList.add('hidden');
    }

    // Send data to backend
    async function sendToBackend(data) {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.message || 'Backend operation failed');
      }
      
      return result;
    }

    // Add to offline queue
    function addToOfflineQueue(data) {
      const offlineData = {
        id: Date.now() + Math.random(),
        type: data.action,
        data: data,
        timestamp: new Date().toISOString()
      };
      
      appState.offlineQueue.push(offlineData);
      saveToStorage('offlineQueue', appState.offlineQueue);
    }

    // Sync offline data
    async function syncOfflineData() {
      const savedQueue = getFromStorage('offlineQueue');
      if (savedQueue && savedQueue.length > 0) {
        appState.offlineQueue = savedQueue;
        
        try {
          const syncData = {
            action: 'syncOfflineData',
            offlineData: appState.offlineQueue
          };
          
          await sendToBackend(syncData);
          
          // Clear offline queue
          appState.offlineQueue = [];
          saveToStorage('offlineQueue', []);
          
          showAlert(`Synced ${savedQueue.length} offline entries`, 'success');
        } catch (error) {
          console.log('Offline sync failed, will retry later');
        }
      }
    }

    // Get current location
    async function getCurrentLocation() {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const location = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                timestamp: new Date().toISOString()
              };
              resolve(location);
            },
            (error) => {
              console.log('Location access denied or unavailable');
              resolve({ error: 'Location unavailable' });
            }
          );
        } else {
          resolve({ error: 'Geolocation not supported' });
        }
      });
    }

    // Show alert
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      
      const icon = type === 'success' ? '✅' : '❌';
      alert.innerHTML = `
        <span class="alert-icon">${icon}</span>
        <span>${message}</span>
      `;
      
      container.appendChild(alert);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // Storage helpers
    function saveToStorage(key, data) {
      try {
        const jsonData = JSON.stringify(data);
        window.localStorage.setItem(key, jsonData);
      } catch (error) {
        console.warn('Failed to save to storage:', error);
      }
    }

    function getFromStorage(key) {
      try {
        const data = window.localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (error) {
        console.warn('Failed to get from storage:', error);
        return null;
      }
    }

    // Reset application
    function resetApp() {
      if (confirm('Are you sure you want to reset all data? This will clear all saved information.')) {
        // Clear storage
        ['userRoutePlan', 'offlineQueue', 'capturedPhotos'].forEach(key => {
          window.localStorage.removeItem(key);
        });
        
        // Reset state
        appState = {
          user: {
            email: 'local@local',
            displayName: 'Field Agent',
            routePlan: ''
          },
          capturedPhotos: {},
          currentPhotoType: null,
          transportMethod: null,
          sessionData: [],
          offlineQueue: []
        };
        
        // Reset UI
        document.getElementById('routePlanText').textContent = 'No route plan configured. Please set your daily route below.';
        document.getElementById('globalRoutePlan').value = '';
        resetCheckinForm();
        resetCheckoutForm();
        hideAllForms();
        updateUserDisplay();
        
        // Clear alerts
        document.getElementById('alertContainer').innerHTML = '';
        
        showAlert('System reset successfully!', 'success');
      }
    }

    // Network status monitoring
    window.addEventListener('online', () => {
      console.log('Connection restored');
      syncOfflineData();
    });

    window.addEventListener('offline', () => {
      console.log('Connection lost - entering offline mode');
      showAlert('Working offline. Data will sync when connection is restored.', 'warning');
    });

    // Initialize app when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      
      // Check for saved offline data
      const savedQueue = getFromStorage('offlineQueue');
      if (savedQueue && savedQueue.length > 0) {
        showAlert(`Found ${savedQueue.length} offline entries. Attempting to sync...`, 'success');
      }
      
      // Auto-sync every 5 minutes
      setInterval(syncOfflineData, 5 * 60 * 1000);
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        // Page became visible, try to sync
        syncOfflineData();
      }
    });

    // Service Worker for offline functionality (optional enhancement)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // You can register a service worker here for enhanced offline capabilities
        console.log('Service worker support available');
      });
    }

    // PWA support
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('PWA install prompt available');
    });

    // Export functionality (for reports)
    function exportData() {
      const data = {
        user: appState.user,
        offlineQueue: appState.offlineQueue,
        timestamp: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `field_force_data_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
    }

    // Debug helpers (remove in production)
    window.appDebug = {
      state: () => console.log('App State:', appState),
      storage: () => console.log('Storage:', {
        route: getFromStorage('userRoutePlan'),
        queue: getFromStorage('offlineQueue')
      }),
      clearStorage: () => {
        localStorage.clear();
        console.log('Storage cleared');
      },
      testAlert: (msg, type) => showAlert(msg, type),
      exportData: exportData
    };
  </script>
</body>
</html>
